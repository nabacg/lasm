name: Tests

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    name: Test on Java ${{ matrix.java-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: ['17', '21']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ matrix.java-version }}

    - name: Install Clojure
      uses: DeLaGuardo/setup-clojure@12.5
      with:
        cli: 1.12.0.1530

    - name: Cache Clojure dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.m2/repository
          ~/.gitlibs
          ~/.deps.clj
        key: ${{ runner.os }}-java${{ matrix.java-version }}-clojure-${{ hashFiles('**/deps.edn') }}
        restore-keys: |
          ${{ runner.os }}-java${{ matrix.java-version }}-clojure-

    - name: Run tests
      run: clojure -M:tests

    - name: Test example files compile
      run: |
        echo "Testing that all example files parse and compile..."
        clojure -M -e "
        (require '[lasm.parser :as p]
                 '[lasm.ast :as ast]
                 '[instaparse.core :as insta])

        (doseq [file (file-seq (clojure.java.io/file \"examples\"))
                :when (.endsWith (.getName file) \".lasm\")]
          (println \"Testing\" (.getName file))
          (let [code (slurp file)
                parsed (p/parser code)]
            (if (insta/failure? parsed)
              (do
                (println \"❌ FAILED:\" (.getName file))
                (println parsed)
                (System/exit 1))
              (do
                (ast/build-program (p/parse-tree-to-ast parsed))
                (println \"✓ OK:\" (.getName file))))))

        (println \"\n✅ All example files compile successfully!\")
        "

    - name: Report test results
      if: always()
      run: echo "Test run completed on Java ${{ matrix.java-version }}"
