name: Tests

on:
  push:
    branches: [ master, main, 'claude/**', 'scratch/**' ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    name: Run Lasm Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Install Clojure
      uses: DeLaGuardo/setup-clojure@12.5
      with:
        cli: 1.11.1.1273

    - name: Cache Clojure dependencies
      uses: actions/cache@v4
      continue-on-error: true
      with:
        path: |
          ~/.m2/repository
          ~/.gitlibs
          ~/.deps.clj
        key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
        restore-keys: |
          ${{ runner.os }}-clojure-

    - name: Download dependencies
      run: |
        echo "Downloading LASM dependencies..."
        clojure -P -M:tests

    - name: Run unit tests (clojure.test)
      run: |
        echo "Running clojure.test suite..."
        echo "Test files:"
        find test -name "*.clj" -type f
        echo ""
        echo "Running tests with verbose output..."
        clojure -M:tests 2>&1 || {
          echo "❌ Tests failed with exit code $?"
          echo "Attempting to run tests individually to identify failure..."
          for ns in lasm.parser-test lasm.examples-test lasm.end-2-end-test; do
            echo "Testing namespace: $ns"
            clojure -M -e "(require 'clojure.test '$ns) (clojure.test/run-tests '$ns)" || echo "  ❌ $ns failed"
          done
          exit 1
        }

    - name: Run comprehensive manual test suite
      run: |
        echo "Running manual test suite..."
        chmod +x manual_test_suite.clj
        clojure manual_test_suite.clj

    - name: Test working examples (01-05)
      run: |
        echo "Testing examples that should parse correctly..."
        clojure -M -e "
        (require '[lasm.parser :as p]
                 '[lasm.ast :as ast]
                 '[instaparse.core :as insta])

        (def working-examples [\"01_simple_window.lasm\"
                               \"02_window_with_label.lasm\"
                               \"03_pong.lasm\"
                               \"04_animated_pong.lasm\"
                               \"05_keyboard_test.lasm\"])

        (println \"\n=== Testing Working Examples (should pass) ===\")
        (doseq [filename working-examples]
          (println (str \"\\nTesting \" filename \"...\"))
          (let [file (clojure.java.io/file \"examples\" filename)
                code (slurp file)
                parsed (p/parser code)]
            (if (insta/failure? parsed)
              (do
                (println \"❌ FAILED:\" filename)
                (println parsed)
                (System/exit 1))
              (do
                (ast/build-program (p/parse-tree-to-ast parsed))
                (println \"✓ OK:\" filename)))))

        (println \"\n✅ All working examples compile successfully!\")
        "

    - name: Test invalid examples (06-09)
      run: |
        echo "Testing examples with invalid syntax (should fail)..."
        clojure -M -e "
        (require '[lasm.parser :as p]
                 '[instaparse.core :as insta])

        (def invalid-examples [\"06_pong_full_game.lasm\"
                               \"07_pong_text_mode.lasm\"
                               \"08_pong_working.lasm\"
                               \"09_pong_simple.lasm\"])

        (println \"\n=== Testing Invalid Examples (should correctly fail) ===\")
        (doseq [filename invalid-examples]
          (let [file (clojure.java.io/file \"examples\" filename)]
            (when (.exists file)
              (println (str \"\\nTesting \" filename \"...\"))
              (let [code (slurp file)
                    parsed (p/parser code)]
                (if (insta/failure? parsed)
                  (println \"✓ Correctly failed:\" filename)
                  (do
                    (println \"❌ Should have failed but didn't:\" filename)
                    (System/exit 1)))))))

        (println \"\n✅ All invalid examples correctly rejected!\")
        "

    - name: Test parser fix for multi-method proxies
      run: |
        echo "Verifying 3+ method proxy fix..."
        clojure -M -e "
        (require '[lasm.parser :as p]
                 '[lasm.ast :as ast]
                 '[instaparse.core :as insta])

        (def keylistener-code
          \"listener:java.awt.event.KeyListener = proxy java.awt.event.KeyListener {
             keyPressed(e:java.awt.event.KeyEvent): void => { printstr(\\\"pressed\\\") }
             keyReleased(e:java.awt.event.KeyEvent): void => { printstr(\\\"released\\\") }
             keyTyped(e:java.awt.event.KeyEvent): void => { printstr(\\\"typed\\\") }
           }\")

        (println \"\n=== Testing Multi-Method Proxy (KeyListener) ===\")
        (let [parsed (p/parser keylistener-code)]
          (if (insta/failure? parsed)
            (do
              (println \"❌ FAILED: 3-method proxy should parse after fix\")
              (println parsed)
              (System/exit 1))
            (do
              (ast/build-program (p/parse-tree-to-ast parsed))
              (println \"✓ 3-method proxy works correctly\"))))

        (println \"\n✅ Parser fix verified!\")
        "

    - name: Test end-to-end compilation
      run: |
        echo "Testing end-to-end compilation and execution..."
        clojure -M -e "
        (require '[lasm.parser :as p]
                 '[lasm.ast :as ast]
                 '[lasm.emit :as emit])

        (println \"\n=== Testing End-to-End Compilation ===\")

        ;; Test factorial
        (let [fact-code \"fn fact(x:int): int =>
                           if x <= 1
                             1
                           else
                             x * fact(x - 1)
                         fact(5)\"
              result (-> (p/parser fact-code)
                        p/parse-tree-to-ast
                        ast/build-program
                        emit/emit-and-run!)]
          (if (= result 120)
            (println \"✓ Factorial test passed (120)\")
            (do
              (println \"❌ Factorial test failed, expected 120, got\" result)
              (System/exit 1))))

        ;; Test fibonacci
        (let [fib-code \"fn fib(x:int): int =>
                          if x < 2
                            1
                          else
                            fib(x - 1) + fib(x - 2)
                        fib(10)\"
              result (-> (p/parser fib-code)
                        p/parse-tree-to-ast
                        ast/build-program
                        emit/emit-and-run!)]
          (if (= result 89)
            (println \"✓ Fibonacci test passed (89)\")
            (do
              (println \"❌ Fibonacci test failed, expected 89, got\" result)
              (System/exit 1))))

        ;; Test string operations
        (let [str-code \"fn test(): string => {
                          s:string = \\\"hello\\\"
                          s.toUpperCase()
                        }
                        test()\"
              result (-> (p/parser str-code)
                        p/parse-tree-to-ast
                        ast/build-program
                        emit/emit-and-run!)]
          (if (= result \"HELLO\")
            (println \"✓ String operations test passed\")
            (do
              (println \"❌ String operations test failed, expected HELLO, got\" result)
              (System/exit 1))))

        (println \"\n✅ All end-to-end tests passed!\")
        "

    - name: Report test results
      if: always()
      run: |
        echo ""
        echo "════════════════════════════════════════════════════════"
        echo "              TEST RUN COMPLETED"
        echo "════════════════════════════════════════════════════════"
        echo ""
        echo "✓ Unit tests (clojure.test)"
        echo "✓ Comprehensive manual test suite"
        echo "✓ Working examples (01-05)"
        echo "✓ Invalid examples correctly rejected (06-09)"
        echo "✓ Multi-method proxy fix verified"
        echo "✓ End-to-end compilation tests"
        echo ""
